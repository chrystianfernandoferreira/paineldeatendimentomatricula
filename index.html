<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel ETEC - Resposta Instantﾃ｢nea</title>
    <style>
        /* CSS MANTIDO CONFORME SOLICITAﾃﾃグ DE CENTRALIZAﾃﾃグ E RESPONSIVIDADE */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html {
            width: 100%; height: 100%; background: #020617;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Segoe UI', Roboto, sans-serif; color: #ffffff; overflow: hidden;
        }
        .screen {
            display: flex; flex-direction: column; width: 96vw; height: 96vh;
            background: linear-gradient(135deg, #7f1d1d, #1f2937);
            border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .header { flex: 0 0 auto; background: #991b1b; text-align: center; padding: 2vh; border-bottom: 5px solid #fde047; }
        .header h1 { font-size: clamp(1.2rem, 4vh, 3rem); text-transform: uppercase; font-weight: 900; }
        .senha-principal { font-size: clamp(3.5rem, 22vh, 18rem); font-weight: 900; color: #fde047; line-height: 1; margin: 0.5vh 0; text-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        .setor-principal { font-size: clamp(1.1rem, 5vh, 4.5rem); font-weight: bold; }
        .content { flex: 1; display: flex; gap: 2vmin; padding: 2vmin; align-items: stretch; }
        @media (max-width: 768px) or (orientation: portrait) { .content { flex-direction: column; } .screen { width: 98vw; height: 98vh; } }
        .section { flex: 1; background: #f3f4f6; color: #000; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2vmin; }
        .section h2 { font-size: clamp(1rem, 3.5vh, 2rem); color: #7f1d1d; text-transform: uppercase; font-weight: 800; }
        .info { font-size: clamp(0.9rem, 3vh, 1.8rem); font-weight: bold; }
        .controls { background: #020617; padding: 2vmin; display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5vmin; }
        button { font-size: clamp(0.8rem, 2.2vh, 1.4rem); padding: 1.5vh 3vw; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; flex: 1; min-width: 120px; transition: transform 0.05s; }
        button:active { transform: scale(0.95); }
        .doc { background: #dc2626; color: #fff; }
        .mat { background: #334155; color: #fff; }
        .reset { background: #f59e0b; color: #000; }
        .footer { background: #020617; text-align: center; padding: 1.5vh; font-size: clamp(0.6rem, 1.8vh, 1rem); border-top: 1px solid #1f2937; }
    </style>
</head>
<body>

<div class="screen">
    <div class="header">
        <h1>SENHA EM ATENDIMENTO</h1>
        <div class="senha-principal" id="senha">--</div>
        <div class="setor-principal" id="setor">AGUARDANDO</div>
    </div>

    <div class="content">
        <div class="section">
            <h2>DOCUMENTAﾃﾃグ</h2>
            <div class="info">Atendendo: <strong id="docAtual">--</strong></div>
            <div class="info">Prﾃｳxima: <strong id="docProx">1</strong></div>
        </div>
        <div class="section">
            <h2>MATRﾃ垢ULA</h2>
            <div class="info">Atendendo: <strong id="matAtual">--</strong></div>
            <div class="info">Prﾃｳxima: <strong id="matProx">1</strong></div>
        </div>
    </div>

    <div class="controls">
        <button class="doc" id="btnDoc">塘 Documentaﾃｧﾃ｣o (F1)</button>
        <button class="mat" id="btnMat">統 Matrﾃｭcula (F2)</button>
        <button class="reset" id="btnReset">売 Redefinir (F3)</button>
    </div>
    <div class="footer">Etec Sylvio de Mattos Carvalho 窶｢ Centro Paula Souza</div>
</div>

<audio id="tindon" src="https://actions.google.com/sounds/v1/alarms/airport_chime.ogg" preload="auto"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCfaPNHgxrem88R7x8dKD9j2SzTYPm9v10",
        authDomain: "painel-senhas-etec.firebaseapp.com",
        databaseURL: "https://painel-senhas-etec-default-rtdb.firebaseio.com",
        projectId: "painel-senhas-etec",
        storageBucket: "painel-senhas-etec.appspot.com",
        messagingSenderId: "52328553080",
        appId: "1:52328553080:web:1fcdda82a6bdbf70732b8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const estadoRef = ref(db, "estado");
    
    // Controle rigoroso de sincronia para evitar falhas de execuﾃｧﾃ｣o repetida ou atrasada
    let ultimoTimestampProcessado = 0;

    function executarChamadaVoz(senha, setor) {
        // 1. Toca o sino instantaneamente
        const audio = document.getElementById('tindon');
        audio.pause();
        audio.currentTime = 0;
        audio.play().catch(e => console.warn("ﾃ「dio requer interaﾃｧﾃ｣o prﾃｩvia."));

        // 2. Executa a voz (synthesis)
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); // Para qualquer fala anterior imediatamente
            const frase = new SpeechSynthesisUtterance(`Senha nﾃｺmero ${senha}, setor ${setor}`);
            frase.lang = "pt-BR";
            frase.rate = 1.1; // Velocidade ideal para clareza e agilidade
            frase.pitch = 1.0;
            window.speechSynthesis.speak(frase);
        }
    }

    async function incrementarSenha(tipo) {
        const snap = await get(estadoRef);
        let d = snap.exists() ? snap.val() : { docAtual: "--", docProx: 1, matAtual: "--", matProx: 1 };

        let updates = {};
        if (tipo === "DOCUMENTACAO") {
            updates['docAtual'] = d.docProx;
            updates['senha'] = d.docProx;
            updates['docProx'] = d.docProx + 1;
            updates['setor'] = "DOCUMENTAﾃﾃグ";
        } else {
            updates['matAtual'] = d.matProx;
            updates['senha'] = d.matProx;
            updates['matProx'] = d.matProx + 1;
            updates['setor'] = "MATRﾃ垢ULA";
        }
        
        // O segredo do tempo real: enviamos o timestamp exato do sistema
        updates['trigger'] = Date.now();
        
        await update(estadoRef, updates);
    }

    // LISTENER EM TEMPO REAL (Dispara em todos os dispositivos simultaneamente)
    onValue(estadoRef, (snap) => {
        if (!snap.exists()) return;
        const dados = snap.val();

        // Atualiza a interface visual
        document.getElementById('senha').textContent = dados.senha || "--";
        document.getElementById('setor').textContent = dados.setor || "AGUARDANDO";
        document.getElementById('docAtual').textContent = dados.docAtual || "--";
        document.getElementById('docProx').textContent = dados.docProx || "1";
        document.getElementById('matAtual').textContent = dados.matAtual || "--";
        document.getElementById('matProx').textContent = dados.matProx || "1";

        // Verifica o gatilho de ﾃ｡udio
        if (dados.trigger && dados.trigger > ultimoTimestampProcessado) {
            ultimoTimestampProcessado = dados.trigger;
            if (dados.senha && dados.senha !== "--") {
                executarChamadaVoz(dados.senha, dados.setor);
            }
        }
    });

    // Eventos de clique
    document.getElementById('btnDoc').onclick = () => incrementarSenha("DOCUMENTACAO");
    document.getElementById('btnMat').onclick = () => incrementarSenha("MATRICULA");
    document.getElementById('btnReset').onclick = async () => {
        if (confirm("Redefinir painel?")) {
            await set(estadoRef, { docAtual: "--", docProx: 1, matAtual: "--", matProx: 1, senha: "--", setor: "AGUARDANDO", trigger: 0 });
            window.location.reload();
        }
    };

    // Atalhos de teclado
    window.onkeydown = (e) => {
        if (e.key === 'F1') { e.preventDefault(); incrementarSenha("DOCUMENTACAO"); }
        if (e.key === 'F2') { e.preventDefault(); incrementarSenha("MATRICULA"); }
        if (e.key === 'F3') { e.preventDefault(); document.getElementById('btnReset').click(); }
    };
</script>
</body>
</html>
